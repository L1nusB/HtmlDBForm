<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Data Table</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/2.2.1/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        .table {
            width: 100% !important;
        }
        .checkbox-cell {
            text-align: center;
        }
        .dataTables_filter {
            margin-bottom: 1rem;
        }
        /* More specific selector to override Bootstrap's table background */
        tr.modified-row,
        tr.modified-row > td {
            background-color: #fff3cd !important;
        }
        /* Maintain striping for modified rows */
        tr.modified-row:nth-of-type(odd) > td {
            background-color: #fff3cd !important;
        }
        tr.modified-row:nth-of-type(even) > td {
            background-color: #fff3cd !important;
        }
        .action-buttons {
            margin-bottom: 1rem;
        }
        .revert-cell {
            width: 40px;
            text-align: center;
        }
        .revert-btn {
            color: #6c757d;  /* Default grey color */
        }
        .revert-btn.active {
            color: #dc3545;  /* Red color for active state */
            cursor: pointer;
        }
        .revert-btn.active:hover {
            color: #bb2d3b;  /* Darker red on hover for active state */
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .delete-checkbox-cell {
            width: 40px !important;
            text-align: center;
            padding: 0.5rem !important;
        }
        /* Ensure the danger background is visible even with striping */
        .table-danger,
        .table-danger > td,
        .table-danger > th {
            background-color: #f8d7da !important;
        }
    </style>
</head>
<body class="container py-4">
    <h2>Data Table</h2>
    <div class="action-buttons">
        <button id="deleteBtn" class="btn btn-danger me-2">
            <i class="bi bi-trash"></i> Delete
        </button>
        <button id="confirmDeleteModeBtn" class="btn btn-danger me-2 d-none">
            <i class="bi bi-check-lg"></i> Confirm
        </button>
        <button id="cancelDeleteBtn" class="btn btn-secondary me-2 d-none">
            <i class="bi bi-x-lg"></i> Cancel
        </button>
        <button id="addEntriesBtn" class="btn btn-success me-2">
            <i class="bi bi-plus-lg"></i> Add
        </button>
        <button id="modifyBtn" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Modify
        </button>
        <button id="modifySaveBtn" class="btn btn-success d-none">
            <i class="bi bi-check-lg"></i> Save
        </button>
        <button id="modifyCancelBtn" class="btn btn-danger d-none">
            <i class="bi bi-x-lg"></i> Cancel
        </button>
    </div>
    <table id="dataTable" class="table">
        <thead>
            <tr>
                <th class="delete-checkbox-cell d-none">#</th>
                <th>Number</th>
                <th>Name</th>
                <th>Process 1</th>
                <th>Process 2</th>
                <th class="revert-cell d-none">Revert</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <!-- Toast Container -->
    <div class="toast-container">
        <div id="saveToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <!-- Toast message will be set dynamically -->
                </div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modals -->
    <div class="modal fade" id="saveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Save</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to save your changes?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" id="confirmSave">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cancelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Cancel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to discard all changes?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" id="confirmCancel">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal HTML structure for adding new entries -->
    <div class="modal fade" id="addEntriesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Entries</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Temporary entries table -->
                    <div id="tempEntriesContainer" class="mb-4 d-none">
                        <h6>Entries to be added:</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Number</th>
                                    <th>Name</th>
                                    <th class="text-center">Process 1</th>
                                    <th class="text-center">Process 2</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="tempEntriesBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Entry form -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="newEntryNumber" class="form-label">Number</label>
                            <input type="text" class="form-control" id="newEntryNumber" required>
                            <div class="invalid-feedback">Please enter a number.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="newEntryName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="newEntryName" required>
                            <div class="invalid-feedback">Please enter a name.</div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="newEntryProcess1">
                                <label class="form-check-label" for="newEntryProcess1">Process 1</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="newEntryProcess2">
                                <label class="form-check-label" for="newEntryProcess2">Process 2</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <button id="addToTempBtn" class="btn btn-primary">
                                <i class="bi bi-plus-lg"></i> Add Entry
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveNewEntriesBtn">Save All Entries</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal HTML structure for confirming deletion -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the selected rows? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                    <button type="button" class="btn btn-danger" id="finalConfirmDeleteBtn">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/2.2.1/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.2.1/js/dataTables.bootstrap5.min.js"></script>

    <!-- Overview + Modify JS -->
     <script src="dynamicColumns.js"></script>
     <script src="table.js"></script>
     <script src="utils.js"></script>
     <script src="editMode.js"></script>
     <script src="addModal.js"></script>
     <script src="delete.js"></script>

     <script>
        // Mock data
        let data = [
            { number: "A123", name: "John Smith", process1: true, process2: false, process3: true},
            { number: "B456", name: "Jane Doe", process1: false, process2: true, process3: false},
            { number: "C789", name: "Bob Johnson", process1: true, process2: true, process3: true, process4: true},
            { number: "D012", name: "Alice Brown", process1: false, process2: false, process3: true },
            { number: "E345", name: "Charlie Davis", process1: true, process2: false, process3: true }
        ];

        $(document).ready(function() {
            // Replace the static table with our dynamic one
            $('#dataTable').replaceWith(generateTableHeader());
                
            // Add the dynamic modal structure for adding new entries
            $('#addEntriesModal').replaceWith(generateAddEntriesModal());

            initializeTable();
        
            // Handle Modify button click
            $('#modifyBtn').click(enterEditMode);

            // Delete button click handler
            $('#deleteBtn').click(enterDeleteMode);

            // Cancel delete button click handler
            $('#cancelDeleteBtn').click(exitDeleteMode);

            // Confirm delete button click handler
            $('#confirmDeleteModeBtn').click(function() {
                if (rowsToDelete.size === 0) {
                    showToast("No rows selected for deletion", false);
                    exitDeleteMode();
                    return;
                }
                
                $('#confirmDeleteModal').modal('show');
            });
            
            // Final delete confirmation handler
            $('#finalConfirmDeleteBtn').click(function() {
                console.log("Second");
                const rowIndices = Array.from(rowsToDelete).sort((a, b) => b - a);
                
                // Remove the rows from the data array
                rowIndices.forEach(index => {
                    data.splice(index, 1);
                });
                
                // Update the table
                table.clear().rows.add(data).draw();
                
                // Show success message and exit delete mode
                showToast(`Successfully deleted ${rowIndices.length} rows`, true);
                $('#confirmDeleteModal').modal('hide');
                exitDeleteMode();
            });

            // Delete checkbox change handler
            $('#dataTable').on('change', '.delete-checkbox', function() {
                if (!deleteMode) return;
                
                const rowIndex = $(this).data('row');
                const row = $(this).closest('tr');
                
                if (this.checked) {
                    rowsToDelete.add(rowIndex);
                    row.addClass('table-danger');
                } else {
                    rowsToDelete.delete(rowIndex);
                    row.removeClass('table-danger');
                }
            });
        
            // Handle checkbox changes
            $('#dataTable').on('change', '.process-checkbox', function() {
                if (editMode) {
                    const checkbox = $(this);
                    const rowIndex = checkbox.data('row');
                    const process = checkbox.data('process');
                    
                    data[rowIndex][process] = checkbox.prop('checked');
                    updateModifiedState(rowIndex);
                }
            });
        
            // Handle revert button clicks
            $('#dataTable').on('click', '.revert-btn', function() {
                const rowIndex = $(this).data('row');
                revertRow(rowIndex);
            });
        
            // Handle Save button click
            $('#modifySaveBtn').click(function() {
                if (modifiedRows.size > 0) {
                    $('#saveModal').modal('show');
                } else {
                    finalizeSave();
                }
            });
        
            // Handle Cancel button click
            $('#modifyCancelBtn').click(function() {
                if (modifiedRows.size > 0) {
                    $('#cancelModal').modal('show');
                } else {
                    data = JSON.parse(JSON.stringify(originalData));
                    table.clear().rows.add(data).draw(false);
                    // Re-enable checkboxes if still in edit mode
                    if (editMode) {
                        $('.process-checkbox').prop('disabled', false);
                    }
                    exitEditMode();
                }
            });
        
            // Handle Save confirmation
            $('#confirmSave').click(function() {
                $('#saveModal').modal('hide');
                finalizeSave();
            });
        
            // Handle Cancel confirmation
            $('#confirmCancel').click(function() {
                $('#cancelModal').modal('hide');
                data = JSON.parse(JSON.stringify(originalData));
                table.clear().rows.add(data).draw(false);
                // Re-enable checkboxes if still in edit mode
                if (editMode) {
                    $('.process-checkbox').prop('disabled', false);
                }
                exitEditMode();
            });

            // Handle Add Entries button click
            $('#addEntriesBtn').click(function() {
                tempEntries = [];
                resetEntryForm();
                updateTempEntriesTable();
                $('#addEntriesModal').modal('show');
            });
            
            // Handle Add Entry button click
            $('#addToTempBtn').click(function() {
                if (!validateEntryForm()) return;
                
                const newEntry = {
                    number: $('#newEntryNumber').val().trim(),
                    name: $('#newEntryName').val().trim()
                };
                
                // Add process values dynamically
                processColumns.forEach(col => {
                    newEntry[col.toLowerCase()] = $(`#newEntry${col}`).prop('checked');
                });
                
                tempEntries.push(newEntry);
                updateTempEntriesTable();
                resetEntryForm();
            });
            
            // Handle remove temporary entry
            $('#tempEntriesBody').on('click', '.remove-temp-entry', function() {
                const index = $(this).data('index');
                tempEntries.splice(index, 1);
                updateTempEntriesTable();
            });
            
            // Handle Save All Entries button click
            $('#saveNewEntriesBtn').click(function() {
                if (tempEntries.length === 0) {
                    showToast("No entries to save", false);
                    return;
                }
                
                // Add all temporary entries to the main data array
                data.push(...tempEntries);
                
                // Refresh the DataTable
                table.clear().rows.add(data).draw();
                
                // Show success message
                showToast(`Successfully added ${tempEntries.length} new entries`, true);
                
                // Close modal and reset
                $('#addEntriesModal').modal('hide');
                tempEntries = [];
            });
            
            // Handle modal hidden event
            $('#addEntriesModal').on('hidden.bs.modal', function() {
                resetEntryForm();
                tempEntries = [];
                updateTempEntriesTable();
            });
        });
     </script>
</body>
</html>